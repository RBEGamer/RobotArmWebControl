<html>

<head>
    <title>RobotArmControl</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./style.css" />
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">Robot Arm Control Interface</a>
        </div>
    </nav>




    <div class="container">



        <!-- Heading Row -->
        <div class="row my-4">

            <div class="col-lg-12" id="canvas_holder">
                <canvas id="tjs_renderer" width="100%" height="500px"></canvas>
            </div>
            <!-- /.col-lg-8 -->

            <!-- /.col-md-4 -->
        </div>
        <!-- /.row -->

        <!-- Call to Action Well  -->
        <div class="card text-white bg-secondary my-4 text-center">
            <div class="card-body">
                <p class="text-white m-0"></p>
            </div>
        </div>

        <!-- Content Row -->
        <div class="row">
            <div class="col-md-5 mb-5">
                <div class="card h-100">
                    <div class="card-body">
                        <h2 class="card-title">AXIS CONTROL</h2>
                        <p class="card-text">

                            <table>
                                <tr>
                                    <td>
                                        <label for="customRange1">AXIS 0</label>
                                        <input type="range" class="custom-range w-50" id="axis_1_slider" onchange="mv_axis(1)"
                                            onmouseover="disable_slider_refresh(1)" onchange="update_slider_text(0)" min="0" max="360">
                                    </td></tr>
                                    <tr><td>
                                        <span id="slider_0_text">0</span>
                                    </td></tr>
                            </table>
                               </p>
                    </div>
                    <div class="card-footer">

                    </div>
                </div>
            </div>
            <!-- /.col-md-4 -->
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h2 class="card-title">START PROGRAM</h2>
                        <p class="card-text">Here you can start a pre recordet program.</p>

                        <div name="dl_btn_div" id="dl_btn_div"></div>

                    </div>
                    <div class="card-footer">

                    </div>
                </div>
            </div>
            <!-- /.col-md-4 -->
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="card-title">INFO</h3>
                        <p class="card-text">
                            Here you can see some information about each axis in you robot arm
                        </p>


                        <h2 class="card-title">AXIS 0</h2>
                        <p class="card-text">
                            __BBBBBB___
                        </p>


                        <h2 class="card-title">AXIS 2</h2>
                        <p class="card-text">
                            <table width="100%">
                                _AAAAAAA__
                        </p>
                    </div>
                    <div class="card-footer">

                    </div>
                </div>
            </div>
            <!-- /.col-md-4 -->

        </div>
        <!-- /.row -->


    </div>










    <script src="./bower_components/jquery/dist/jquery.min.js"></script>
    <script src="./bower_components/bootstrap/dist/js/bootstrap.bundle.js"></script>
    <script src="./three.js/build/three.js"></script>
    <script src="./OrbisControls.js"></script>
    <script src="./three.js/examples/js/loaders/LoaderSupport.js"></script>
    <script src="./three.js/examples/js/loaders/OBJLoader.js"></script>
    <script src="./three.js/examples/js/loaders/DDSLoader.js"></script>
    <script src="./three.js/examples/js/loaders/MTLLoader.js"></script>


    <script>


var uistate = {
    axis_slider_1_refresh: true,
    
}

//MOVE AXIS FUNCTION
function mv_axis(_id,_dir){
    $.get("/axis?id="+ _id + "&degree=" + 0, function (data) {
        console.log(data);
        enable_slider_refresh(_id)
        
    });
}


function update_slider_text(_sl){
    $("#slider_0_text").html($("#axis_1_slider").val());
}
function disable_slider_refresh(_sl){
    
    if(_sl == 1){
        uistate.axis_slider_1_refresh = false;  

    }
}

    function enable_slider_refresh(_sl) {
        if (_sl == 1) {
            uistate.axis_slider_1_refresh = true;
        }
    }
    setInterval(function () { 
        $.get("/axis_state", function (data) {

            console.log(data.status[0]);

            if(uistate.axis_slider_1_refresh && data.status[0] != undefined && data.status[0] != null){
                $("#axis_1_slider").val(data.status[0]);
            }
             if ( data.status[0] != undefined && data.status[0] != null) {
                $("#slider_0_text").html("Echtzeit-Wert: " + data.status[0])
            }
            
        });

     }, 700);




        var stats, mixer, camera, scene, renderer, clock, orbit_controls;

        var base_robot_material = new THREE.MeshBasicMaterial({ color: 'yellow', side: THREE.DoubleSide });
        
        //axis angle 0-360 grad
        var msg = {
            "axis_states": [{ "id": 0, "angle": 0 }]
        }

        var model_scale_factor = 5; //afftess inital scale of all object in robot_arm_model_object
        var all_objects_loaded = false;
        var robot_arm_model_object = [ //axis -1 is the base -> fixed
            {"name":"base_box","axis":-1,"filename": "base_box","model":null,"loaded":false,"position": new THREE.Vector3(0, 1, 0), "initial_roation": new THREE.Vector3(0, 0, 2*Math.PI / 2), "initial_scale":0.01* model_scale_factor},
            { "name": "base", "axis": 0, "filename": "base", "model": null, "loaded": false, "position": new THREE.Vector3(0, 1, -1), "initial_roation": new THREE.Vector3(0, 0, 2 * Math.PI / 2), "initial_scale": 0.01 * model_scale_factor }
        ]

        function isWebGLAvailable() {
            try {
                var canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
            } catch (e) {
                return false;
            }
        }

    function printGraph(obj) {
        console.group(' <' + obj.type + '> ' + obj.name);
        obj.children.forEach(printGraph);
        console.groupEnd();
    }




        $(document).ready(function () {
            console.log("ready!");






            if (isWebGLAvailable()) {
                init();
                animate();
            }


        });



        function init() {
            //CAMERA
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(24, 8, 24);
            //ORBISCONTROLS
            orbit_controls = new THREE.OrbitControls(camera, this.document.getElementById('tjs_renderer'));
            orbit_controls.minDistance = 20.0;
            orbit_controls.maxDistance = 100.0;
            orbit_controls.enableDamping = true;
            orbit_controls.enabled = false;
            orbit_controls.update();
            //ENABLE CONTROL WHEN ENTERING THE CANVAS
            $("#tjs_renderer").on("mouseover", function () {
                orbit_controls.enabled = true;
                orbit_controls.update();
            }).on("mouseleave", function () {
                orbit_controls.enabled = false;
                orbit_controls.update();
            });
            //SCENE SETUP
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xa0a0a0);
            scene.fog = new THREE.Fog(0xa0a0a0, 100, 500); //color, abwann fog, ab wann schwarz
            clock = new THREE.Clock();
            //GROUND PLANTE
            var geometry = new THREE.PlaneBufferGeometry(500, 500);
            var material = new THREE.MeshPhongMaterial({ color: 0x999999, depthWrite: false });
            var ground = new THREE.Mesh(geometry, material);
            ground.position.set(0, - 5, 0);
            ground.rotation.x = - Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            //DRAW GRID
            var grid = new THREE.GridHelper(500, 100, 0x000000, 0x000000);
            grid.position.y = 0;
            grid.material.opacity = 0.2;
            grid.material.transparent = true;
            scene.add(grid);
            // AMBIENT LIGHT
            var light = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
            light.position.set(0, 200, 0);
            scene.add(light);
            light = new THREE.DirectionalLight(0xffffff, 0.1);
            light.position.set(0, 20, 10);
            light.castShadow = true;
            light.shadow.camera.top = 18;
            light.shadow.camera.bottom = - 10;
            light.shadow.camera.left = - 12;
            light.shadow.camera.right = 12;
            scene.add(light);

            var axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);


            var onProgress = function (xhr) {
                if (xhr.lengthComputable) {
                    var percentComplete = xhr.loaded / xhr.total * 100;
                    console.log(Math.round(percentComplete, 2) + '% downloaded');
                }
            };

            var onError = function (xhr) {alert(xhr); };

            THREE.Loader.Handlers.add(/\.dds$/i, new THREE.DDSLoader());


            function load_3d_model(_robot_arm_model_object_ref){
                console.log("LOADING :" + _robot_arm_model_object_ref.name);
                new THREE.MTLLoader().setPath("./3d_models/").load(_robot_arm_model_object_ref.filename+".mtl", function (materials) {
                        materials.preload();
                        var objLoader = new THREE.OBJLoader().setMaterials(materials).setPath("./3d_models/").load(_robot_arm_model_object_ref.filename + ".obj", function (object) {
                                object.castShadow = true;
                                _robot_arm_model_object_ref.model = object;
                                _robot_arm_model_object_ref.model.scale.set(_robot_arm_model_object_ref.initial_scale, _robot_arm_model_object_ref.initial_scale, _robot_arm_model_object_ref.initial_scale);
                                object.position = _robot_arm_model_object_ref.position;
                                _robot_arm_model_object_ref.loaded = true;
                                _robot_arm_model_object_ref.model.rotation.z = _robot_arm_model_object_ref.initial_roation.z;
                               
                            }, onProgress, onError);

                    });
            }
            
            

            //LOAD ALL 3D MODELS
            for (let index = 0; index < robot_arm_model_object.length; index++) {
                const element = robot_arm_model_object[index];
                load_3d_model(element);
            }



            //WAIT FOR ALL OBJECTS ARE LOADED
           var intervalID = window.setInterval(function(){
               var all_loaded = true;
            for (let index = 0; index < robot_arm_model_object.length; index++) {
                const element = robot_arm_model_object[index];
                if(!element.loaded){
                    all_loaded = false;
                    break;
                }
            }
            if(all_loaded){
                console.log("all obj loaded");
                clearInterval(intervalID);

                for (let index = 0; index < robot_arm_model_object.length; index++) {
                    if (robot_arm_model_object[index].axis == -1) {
                        console.log("scene.add(" + robot_arm_model_object[index].name + ")");
                        scene.add(robot_arm_model_object[index].model);
                    }
                }

                for (let index = 0; index < robot_arm_model_object.length; index++) {
                    const el0 = robot_arm_model_object[index];
                        for (let windex = 0; windex < robot_arm_model_object.length; windex++) {
                            const el1 = robot_arm_model_object[windex];         
                            if(el0.axis < el1.axis && Math.abs(el0.axis-el1.axis) == 1){
                                robot_arm_model_object[index].model.add(robot_arm_model_object[windex].model);
                                console.log("ADD CHILD:" + el0.name + ".add(" + el1.name + ")");


                             

                            }
                    }  
                }


                 
               
                printGraph(scene);
                
                //TODO CREATE CHILDS base->axis0->axis1
            //TODO AJUST PIVOTS
            //ADD BASE TO SCENE


            }
           }, 500);
           
            
            
            



            //RENDERER
            renderer = new THREE.WebGLRenderer({ canvas: tjs_renderer });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(1100, 600);
            renderer.shadowMap.enabled = true;


        }

        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(clock.getDelta());
            render();

        }
        function render() {
            renderer.render(scene, camera);
        }

    </script>
</body>

</html>
